{% extends "base.html" %}
{% block content %}
<div class="d-flex align-items-center mb-3">
  <h1 class="h4 m-0">Compose from linked ideas</h1>
  <span class="ms-3 small text-muted">Pick a seed idea; we'll synthesize using it and its linked neighbors. No new nodes are created.</span>
</div>
<div class="row g-3">
  <div class="col-md-5">
    <div class="mb-3">
      <label class="form-label">Create new idea (paste text)</label>
      <form method="post" action="{{ url_for('compose.compose_create') }}">
        <div class="mb-2">
          <textarea class="form-control" name="content" rows="5" placeholder="Write or paste your idea here..."></textarea>
        </div>
        <div class="mb-2 d-flex gap-2">
          <input class="form-control form-control-sm" name="top_k" type="number" value="5" min="1" style="width:90px;" />
          <button class="btn btn-success btn-sm" type="submit">Create Idea</button>
        </div>
      </form>
    </div>

    <form method="post" action="{{ url_for('compose.compose_synthesize') }}">
      <div class="mb-2">
        <label class="form-label">Seed idea</label>
        <select class="form-select" name="node_id">
          {% for r in rows %}
            <option value="{{ r.node_id }}">{{ (r.title or 'Untitled')[:80] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Topic / prompt (optional)</label>
        <input class="form-control" name="prompt" placeholder="e.g., Draft a coherent overview" />
      </div>
      <button class="btn btn-primary" type="submit">Synthesize</button>
    </form>
    <div class="mt-3 small text-muted">Tip: Use Map â†’ Autolink to create links first, then synthesize here.</div>
  </div>
  <div class="col-md-7">
    {% if result and result.error %}
      <div class="alert alert-danger">{{ result.error }}</div>
    {% elif result and result.ok %}
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">{{ result.data.title }}</h5>
            <button class="btn btn-sm btn-outline-secondary" id="copyBtn">Copy</button>
          </div>
          {% if result.sources %}
          <div class="mt-2 small text-muted">Sources: {% for s in result.sources %}<code class="me-1">{{ s }}</code>{% endfor %}</div>
          {% endif %}
          <hr />
          <pre id="composeOut" style="white-space: pre-wrap" class="mb-0">{{ result.data.content }}</pre>
        </div>
      </div>
    {% else %}
      <div class="alert alert-info">Select a seed idea and click Synthesize.</div>
    {% endif %}
  </div>
</div>
<script>
  const btn = document.getElementById('copyBtn');
  if (btn){ btn.addEventListener('click', ()=>{ const t=document.getElementById('composeOut').innerText; navigator.clipboard.writeText(t).then(()=>{ btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy', 1000); }); }); }
</script>
{% endblock %}
